{"version":3,"file":"TemplateScanner.js","sources":["../../src/scanner/TemplateScanner.ts"],"sourcesContent":["import type { TemplateMetadata, TemplateConfig } from '@ldesign/template-core'\r\nimport { parsePath, generateTemplateId } from '@ldesign/template-core'\r\nimport type { Component } from 'vue'\r\n\r\n/**\r\n * Glob 模块类型\r\n */\r\ntype GlobModule<T = any> = Record<string, () => Promise<T>>\r\ntype GlobEagerModule<T = any> = Record<string, T>\r\n\r\n/**\r\n * 模板扫描器\r\n * 使用 import.meta.glob 自动发现和加载模板\r\n */\r\nexport class TemplateScanner {\r\n  /**\r\n   * 懒加载组件模块\r\n   * eager: false 表示返回加载函数,不立即执行\r\n   */\r\n  private lazyComponents: GlobModule<{ default: Component }>\r\n\r\n  /**\r\n   * 即时加载配置模块\r\n   * eager: true 表示构建时就加载\r\n   */\r\n  private eagerConfigs: GlobEagerModule<TemplateConfig>\r\n\r\n  constructor() {\r\n    // 扫描所有模板组件\r\n    // 路径模式: ../templates/{category}/{device}/{name}/index.vue\r\n    this.lazyComponents = import.meta.glob(\r\n      '../templates/**/{desktop,mobile,tablet}/*/index.vue',\r\n      { eager: false }\r\n    ) as GlobModule<{ default: Component }>\r\n\r\n    // 扫描所有配置文件\r\n    // 路径模式: ../templates/{category}/{device}/{name}/template.config.ts\r\n    this.eagerConfigs = import.meta.glob(\r\n      '../templates/**/{desktop,mobile,tablet}/*/template.config.ts',\r\n      { eager: true, import: 'default' }\r\n    ) as GlobEagerModule<TemplateConfig>\r\n  }\r\n\r\n  /**\r\n   * 扫描并生成模板元数据列表\r\n   */\r\n  scan(): TemplateMetadata[] {\r\n    const templates: TemplateMetadata[] = []\r\n\r\n    for (const [componentPath, loader] of Object.entries(this.lazyComponents)) {\r\n      // 解析路径信息\r\n      const parsed = parsePath(componentPath)\r\n      \r\n      if (!parsed) {\r\n        console.warn(`无法解析模板路径: ${componentPath}`)\r\n        continue\r\n      }\r\n\r\n      const { category, device, name } = parsed\r\n\r\n      // 生成模板 ID\r\n      const id = generateTemplateId(category, device, name)\r\n\r\n      // 查找对应的配置文件\r\n      const configPath = componentPath.replace('index.vue', 'template.config.ts')\r\n      const config = this.eagerConfigs[configPath] || {}\r\n\r\n      // 构建模板元数据\r\n      templates.push({\r\n        id,\r\n        category,\r\n        device,\r\n        name,\r\n        path: componentPath,\r\n        loader,\r\n        // 合并配置信息\r\n        displayName: config.displayName,\r\n        description: config.description,\r\n        author: config.author,\r\n        version: config.version,\r\n        preview: config.preview,\r\n        tags: config.tags,\r\n        props: config.props,\r\n        dependencies: config.dependencies,\r\n      })\r\n    }\r\n\r\n    return templates\r\n  }\r\n\r\n  /**\r\n   * 获取所有组件路径\r\n   */\r\n  getComponentPaths(): string[] {\r\n    return Object.keys(this.lazyComponents)\r\n  }\r\n\r\n  /**\r\n   * 获取所有配置路径\r\n   */\r\n  getConfigPaths(): string[] {\r\n    return Object.keys(this.eagerConfigs)\r\n  }\r\n\r\n  /**\r\n   * 获取扫描统计信息\r\n   */\r\n  getStats() {\r\n    const componentCount = Object.keys(this.lazyComponents).length\r\n    const configCount = Object.keys(this.eagerConfigs).length\r\n\r\n    return {\r\n      componentCount,\r\n      configCount,\r\n      matchRate: componentCount > 0 ? (configCount / componentCount) * 100 : 0,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 创建模板扫描器实例\r\n */\r\nexport function createTemplateScanner(): TemplateScanner {\r\n  return new TemplateScanner()\r\n}"],"names":["TemplateScanner","constructor","lazyComponents","import","glob","eager","eagerConfigs","scan","templates","componentPath","loader","Object","entries","parsed","parsePath","console","warn","category","device","name","id","generateTemplateId","configPath","replace","config","push","path","displayName","description","author","version","preview","tags","props","dependencies","getComponentPaths","keys","getConfigPaths","getStats","componentCount","length","configCount","matchRate","createTemplateScanner"],"mappings":"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"}