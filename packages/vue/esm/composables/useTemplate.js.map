{"version":3,"file":"useTemplate.js","sources":["../../src/composables/useTemplate.ts"],"sourcesContent":["import { ref, shallowRef, watch, type Ref, type Component } from 'vue'\r\nimport type { TemplateMetadata } from '@ldesign/template-core'\r\nimport { getTemplateManager } from '../plugin/context'\r\n\r\n/**\r\n * useTemplate 返回值\r\n */\r\nexport interface UseTemplateReturn {\r\n  /**\r\n   * 模板元数据\r\n   */\r\n  template: Ref<TemplateMetadata | undefined>\r\n\r\n  /**\r\n   * 加载的组件\r\n   */\r\n  component: Ref<Component | undefined>\r\n\r\n  /**\r\n   * 加载状态\r\n   */\r\n  loading: Ref<boolean>\r\n\r\n  /**\r\n   * 错误信息\r\n   */\r\n  error: Ref<Error | undefined>\r\n\r\n  /**\r\n   * 加载模板\r\n   */\r\n  load: (id?: string) => Promise<void>\r\n\r\n  /**\r\n   * 卸载模板\r\n   */\r\n  unload: () => void\r\n}\r\n\r\n/**\r\n * 使用模板 Composable\r\n * \r\n * @param templateId - 模板ID或响应式ID\r\n * @param options - 选项\r\n * @returns 模板状态和操作方法\r\n * \r\n * @example\r\n * ```ts\r\n * const { component, loading, error, load } = useTemplate('login:desktop:default')\r\n * \r\n * onMounted(() => load())\r\n * ```\r\n */\r\nexport function useTemplate(\r\n  templateId: string | Ref<string>,\r\n  options: {\r\n    /**\r\n     * 是否自动加载\r\n     * @default false\r\n     */\r\n    immediate?: boolean\r\n    /**\r\n     * 加载成功回调\r\n     */\r\n    onLoad?: (template: TemplateMetadata) => void\r\n    /**\r\n     * 加载失败回调\r\n     */\r\n    onError?: (error: Error) => void\r\n  } = {}\r\n): UseTemplateReturn {\r\n  const { immediate = false, onLoad, onError } = options\r\n\r\n  const template = ref<TemplateMetadata>()\r\n  const component = shallowRef<Component>()\r\n  const loading = ref(false)\r\n  const error = ref<Error>()\r\n\r\n  /**\r\n   * 加载模板\r\n   */\r\n  async function load(id?: string): Promise<void> {\r\n    const targetId = id || (typeof templateId === 'string' ? templateId : templateId.value)\r\n\r\n    if (!targetId) {\r\n      const err = new Error('模板ID不能为空')\r\n      error.value = err\r\n      onError?.(err)\r\n      return\r\n    }\r\n\r\n    loading.value = true\r\n    error.value = undefined\r\n\r\n    try {\r\n      // 获取管理器\r\n      const manager = getTemplateManager()\r\n\r\n      // 1. 从注册表获取元数据\r\n      const meta = manager.resolveTemplate(targetId)\r\n      if (!meta) {\r\n        throw new Error(`模板未找到: ${targetId}`)\r\n      }\r\n      template.value = meta\r\n\r\n      // 2. 动态加载组件\r\n      if (meta.loader) {\r\n        const module = await meta.loader()\r\n        component.value = module.default\r\n        onLoad?.(meta)\r\n      } else {\r\n        throw new Error(`模板缺少加载器: ${targetId}`)\r\n      }\r\n    } catch (e) {\r\n      const err = e as Error\r\n      error.value = err\r\n      console.error('加载模板失败:', err)\r\n      onError?.(err)\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 卸载模板\r\n   */\r\n  function unload(): void {\r\n    component.value = undefined\r\n    template.value = undefined\r\n    error.value = undefined\r\n  }\r\n\r\n  // 响应式ID变化\r\n  if (typeof templateId !== 'string') {\r\n    watch(\r\n      templateId,\r\n      (newId) => {\r\n        if (newId) {\r\n          load(newId)\r\n        } else {\r\n          unload()\r\n        }\r\n      },\r\n      { immediate }\r\n    )\r\n  } else if (immediate) {\r\n    load(templateId)\r\n  }\r\n\r\n  return {\r\n    template,\r\n    component,\r\n    loading,\r\n    error,\r\n    load,\r\n    unload,\r\n  }\r\n}"],"names":["useTemplate","templateId","options","immediate","onLoad","onError","template","ref","component","shallowRef","loading","error","load","id","targetId","value","err","Error","undefined","manager","getTemplateManager","meta","resolveTemplate","loader","module","default","e","console","unload","watch","newId"],"mappings":"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"}